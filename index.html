<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passage - پنل مدیریت کانفیگ</title>
    <link rel="icon" href="favicon.fav">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="rtl">
    <!-- دکوراسیون پس‌زمینه -->
    <div class="bg-decoration">
        <div class="bg-pattern"></div>
        <div class="bg-circle bg-circle-1"></div>
        <div class="bg-circle bg-circle-2"></div>
    </div>

    <!-- کانتینر اصلی -->
    <div class="container">
        <form class="login-form" id="loginForm">
            <!-- هدر فرم -->
            <div class="form-header">
                <div class="logo">
                    <i class="fas fa-route"></i>
                </div>
                <h1 data-i18n="welcome">به Passage خوش آمدید</h1>
                <p data-i18n="login-desc">برای ورود به پنل مدیریت اطلاعات خود را وارد کنید</p>
            </div>

            <!-- پیام خطا -->
            <div class="error-message" id="errorMessage"></div>

            <!-- آدرس ورکر -->
            <div class="form-group">
                <label for="workerUrl" data-i18n="worker-url">آدرس ورکر</label>
                <div class="input-wrapper">
                    <i class="fas fa-link"></i>
                    <input type="url" id="workerUrl" class="form-control" 
                           placeholder="https://your-worker.workers.dev" required>
                </div>
            </div>

            <!-- نام کاربری -->
            <div class="form-group">
                <label for="username" data-i18n="username">نام کاربری</label>
                <div class="input-wrapper">
                    <i class="fas fa-user"></i>
                    <input type="text" id="username" class="form-control" 
                           placeholder="admin" required>
                </div>
            </div>

            <!-- رمز عبور -->
            <div class="form-group">
                <label for="password" data-i18n="password">رمز عبور</label>
                <div class="input-wrapper">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="password" class="form-control" 
                           placeholder="••••••••" required>
                    <button type="button" class="toggle-password" 
                            style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: none; border: none; color: var(--text-secondary); cursor: pointer;">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
            </div>

            <!-- انتخاب زبان -->
            <div class="form-group">
                <label for="language" data-i18n="language">زبان</label>
                <div class="language-selector">
                    <select id="language" class="form-control">
                        <option value="fa">فارسی</option>
                        <option value="en">English</option>
                    </select>
                    <i class="fas fa-globe"></i>
                </div>
            </div>

            <!-- دکمه ورود -->
            <button type="submit" class="btn-login" id="loginBtn">
                <span data-i18n="login">ورود</span>
                <i class="fas fa-arrow-left"></i>
            </button>

            <!-- فوتر فرم -->
            <div class="form-footer">
                <p data-i18n="default-creds">اطلاعات پیش‌فرض: admin / admin</p>
            </div>
        </form>
    </div>

    <!-- اسکریپت‌ها -->
    <script>
        // سیستم چندزبانه
        const translations = {
            fa: {
                welcome: "به Passage خوش آمدید",
                "login-desc": "برای ورود به پنل مدیریت اطلاعات خود را وارد کنید",
                "worker-url": "آدرس ورکر",
                username: "نام کاربری",
                password: "رمز عبور",
                language: "زبان",
                login: "ورود",
                "default-creds": "اطلاعات پیش‌فرض: admin / admin",
                "error-invalid-creds": "نام کاربری یا رمز عبور اشتباه است",
                "error-network": "خطا در ارتباط با سرور",
                "error-unknown": "خطای ناشناخته"
            },
            en: {
                welcome: "Welcome to Passage",
                "login-desc": "Enter your credentials to access the management panel",
                "worker-url": "Worker URL",
                username: "Username",
                password: "Password",
                language: "Language",
                login: "Login",
                "default-creds": "Default credentials: admin / admin",
                "error-invalid-creds": "Invalid username or password",
                "error-network": "Network error",
                "error-unknown": "Unknown error"
            }
        };

        // تابع تغییر زبان
        function setLanguage(lang) {
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'fa' ? 'rtl' : 'ltr';
            
            // به‌روزرسانی متن‌ها
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    element.textContent = translations[lang][key];
                }
            });
            
            // به‌روزرسانی انتخابگر زبان
            document.getElementById('language').value = lang;
        }

        // بارگذاری زبان ذخیره شده
        function initLanguage() {
            const savedLang = localStorage.getItem('language') || 'fa';
            setLanguage(savedLang);
        }

        // تابع نمایش نوتیفیکیشن
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 3000);
        }

        // تابع ورود
        async function login(workerUrl, username, password) {
            const loginBtn = document.getElementById('loginBtn');
            const originalText = loginBtn.innerHTML;
            
            try {
                // نمایش لودینگ
                loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال ورود...';
                loginBtn.disabled = true;
                
                // ارسال درخواست به API
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(`${workerUrl}/api/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        workerUrl,
                        username,
                        password
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // ذخیره اطلاعات ورود به جز توکن
                    localStorage.setItem('workerUrl', workerUrl);
                    localStorage.setItem('username', username);
                    localStorage.setItem('activationDate', new Date().toISOString());
                    
                    // ذخیره توکن در یک متغیر در حافظه (به جای localStorage)
                    window.PASSAGE_TOKEN = data.token;
                    
                    showNotification('ورود با موفقیت انجام شد', 'success');
                    
                    // هدایت به داشبورد
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    showError('error-invalid-creds');
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.name === 'AbortError') {
                    showError('error-network');
                } else {
                    showError('error-unknown');
                }
            } finally {
                // بازگرداندن دکمه به حالت اولیه
                loginBtn.innerHTML = originalText;
                loginBtn.disabled = false;
            }
        }

        // تابع نمایش خطا
        function showError(messageKey) {
            const errorMessage = document.getElementById('errorMessage');
            const lang = localStorage.getItem('language') || 'fa';
            errorMessage.textContent = translations[lang][messageKey];
            errorMessage.classList.add('show');
            
            // مخفی کردن خطا بعد از 5 ثانیه
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }

        // رویداد تغییر زبان
        document.addEventListener('DOMContentLoaded', function() {
            const languageSelector = document.getElementById('language');
            languageSelector.addEventListener('change', function() {
                setLanguage(this.value);
            });
            
            initLanguage();
            
            // تغییر حالت نمایش رمز عبور
            const togglePassword = document.querySelector('.toggle-password');
            const passwordInput = document.getElementById('password');
            
            togglePassword.addEventListener('click', function() {
                const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                passwordInput.setAttribute('type', type);
                
                const icon = this.querySelector('i');
                icon.classList.toggle('fa-eye');
                icon.classList.toggle('fa-eye-slash');
            });
            
            // ارسال فرم ورود
            const loginForm = document.getElementById('loginForm');
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const workerUrl = document.getElementById('workerUrl').value.trim();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                
                // اعتبارسنجی ورودی‌ها
                if (!workerUrl || !username || !password) {
                    showError('error-invalid-creds');
                    return;
                }
                
                // فراخوانی تابع ورود
                login(workerUrl, username, password);
            });
        });
    </script>
</body>

</html>
